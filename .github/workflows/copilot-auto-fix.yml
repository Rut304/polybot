name: Copilot Auto-Fix

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: false
        type: string
  issues:
    types: [labeled]

jobs:
  auto-fix:
    # Run when labeled with 'auto-fix' or triggered manually
    if: github.event_name == 'workflow_dispatch' || contains(github.event.label.name, 'auto-fix')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: admin/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: admin

      - name: Get issue details
        id: issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let issueNumber = '${{ inputs.issue_number }}';
            
            if (!issueNumber && context.eventName === 'issues') {
              issueNumber = context.payload.issue.number;
            }
            
            if (!issueNumber) {
              // Find most recent auto-fix issue
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'auto-fix',
                state: 'open',
                sort: 'created',
                direction: 'desc'
              });
              
              if (issues.data.length > 0) {
                issueNumber = issues.data[0].number;
              }
            }
            
            if (issueNumber) {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber)
              });
              
              core.setOutput('number', issueNumber);
              core.setOutput('title', issue.data.title);
              core.setOutput('body', issue.data.body);
              return issue.data;
            }
            
            core.setFailed('No issue found to fix');

      - name: Create fix branch
        id: branch
        run: |
          BRANCH_NAME="auto-fix/issue-${{ steps.issue.outputs.number }}-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Run TypeScript check and capture errors
        id: typecheck
        continue-on-error: true
        run: |
          npm run typecheck 2>&1 | tee typecheck-errors.txt || true
        working-directory: admin

      - name: Run lint and capture errors
        id: lint
        continue-on-error: true
        run: |
          npm run lint 2>&1 | tee lint-errors.txt || true
        working-directory: admin

      - name: Attempt automated fixes
        run: |
          cd admin
          
          # Auto-fix lint errors
          npx eslint --fix src/ 2>/dev/null || true
          
          # Common TypeScript fixes
          # (These are placeholder - real fixes would need AI analysis)
          
          echo "Automated lint fixes applied"

      - name: Check for changes
        id: changes
        run: |
          cd admin
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff --stat
          fi

      - name: Commit and push fixes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "fix: auto-fix for issue #${{ steps.issue.outputs.number }}
          
          Automated fixes applied:
          - ESLint auto-fixes
          
          Related to #${{ steps.issue.outputs.number }}"
          git push origin ${{ steps.branch.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ¤– Auto-fix: Resolve CI/CD failures',
              head: '${{ steps.branch.outputs.branch_name }}',
              base: 'main',
              body: `## Automated Fix PR
              
            This PR was automatically generated to fix CI/CD failures.
            
            **Related Issue:** #${{ steps.issue.outputs.number }}
            
            ### Changes Made
            - Applied ESLint auto-fixes
            - Fixed code style issues
            
            ### Verification
            Please review and verify:
            - [ ] Changes don't break existing functionality
            - [ ] All tests pass
            - [ ] Code follows project conventions
            
            ---
            *This PR was created by the auto-fix workflow.*`,
              draft: false
            });
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['auto-fix', 'automated']
            });
            
            // Comment on the original issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.issue.outputs.number }},
              body: `ðŸ¤– Auto-fix PR created: #${pr.data.number}\n\nPlease review and merge if the fixes look correct.`
            });
            
            console.log(`Created PR #${pr.data.number}`);

      - name: No changes to fix
        if: steps.changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.issue.outputs.number }},
              body: `ðŸ¤– Auto-fix attempted but no automated fixes were possible.
              
            The issues may require manual intervention. Please review:
            - TypeScript errors in \`admin/typecheck-errors.txt\`
            - Lint errors in \`admin/lint-errors.txt\`
            
            Consider assigning to @copilot for AI-assisted fixes.`
            });
