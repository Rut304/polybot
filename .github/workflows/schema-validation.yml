name: Schema Validation

on:
  push:
    branches: [main]
    paths:
      - 'admin/src/app/settings/**'
      - 'admin/src/app/strategies/**'
      - 'scripts/*.sql'
      - 'src/config.py'
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate-schema:
    runs-on: ubuntu-latest
    name: Validate Database Schema
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Run Schema Validation
        id: validate
        continue-on-error: true  # Don't fail the build
        run: |
          python scripts/validate_schema.py 2>&1 | tee validation_output.txt
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          
      - name: Parse Validation Results
        id: parse
        run: |
          # Extract missing columns from output
          MISSING=$(grep "MISSING COLUMN" validation_output.txt | sed "s/.*'\([^']*\)'.*/\1/" | sort -u | tr '\n' ', ' | sed 's/,$//')
          echo "missing_columns=$MISSING" >> $GITHUB_OUTPUT
          
          # Count issues
          COUNT=$(grep -c "MISSING COLUMN" validation_output.txt || echo "0")
          echo "issue_count=$COUNT" >> $GITHUB_OUTPUT
          
          # Create fix SQL
          if [ "$COUNT" -gt 0 ]; then
            echo "## ðŸš¨ Schema Mismatch Detected" > schema_fix.md
            echo "" >> schema_fix.md
            echo "**$COUNT missing column(s)** found in \`polybot_config\`" >> schema_fix.md
            echo "" >> schema_fix.md
            echo "### Missing Columns:" >> schema_fix.md
            grep "MISSING COLUMN" validation_output.txt | sed "s/.*'\([^']*\)'.*/- \`\1\`/" >> schema_fix.md
            echo "" >> schema_fix.md
            echo "### Auto-Fix SQL:" >> schema_fix.md
            echo "\`\`\`sql" >> schema_fix.md
            echo "-- Run this in Supabase SQL Editor" >> schema_fix.md
            grep "MISSING COLUMN" validation_output.txt | sed "s/.*'\([^']*\)'.*/\1/" | while read col; do
              # Infer type from column name
              if [[ "$col" == enable_* ]] || [[ "$col" == *_enabled ]]; then
                echo "ALTER TABLE polybot_config ADD COLUMN IF NOT EXISTS $col BOOLEAN DEFAULT false;"
              elif [[ "$col" == *_pct ]] || [[ "$col" == *threshold* ]] || [[ "$col" == *_rate ]]; then
                echo "ALTER TABLE polybot_config ADD COLUMN IF NOT EXISTS $col DECIMAL(10,4) DEFAULT 0.5;"
              elif [[ "$col" == *_usd ]] || [[ "$col" == *balance* ]]; then
                echo "ALTER TABLE polybot_config ADD COLUMN IF NOT EXISTS $col DECIMAL(20,4) DEFAULT 1000;"
              elif [[ "$col" == *_sec ]] || [[ "$col" == *_days ]] || [[ "$col" == *_hours ]]; then
                echo "ALTER TABLE polybot_config ADD COLUMN IF NOT EXISTS $col INTEGER DEFAULT 60;"
              else
                echo "ALTER TABLE polybot_config ADD COLUMN IF NOT EXISTS $col TEXT DEFAULT '';"
              fi
            done >> schema_fix.md
            echo "\`\`\`" >> schema_fix.md
          fi
          
      - name: Create Issue for Schema Mismatch
        if: steps.parse.outputs.issue_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('schema_fix.md', 'utf8');
            
            // Check if there's already an open schema issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'schema-mismatch',
              per_page: 1
            });
            
            if (issues.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `## Updated Schema Check (${new Date().toISOString()})\n\n${body}`
              });
              console.log(`Updated existing issue #${issues[0].number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Database Schema Mismatch Detected',
                body: body,
                labels: ['schema-mismatch', 'automated', 'database']
              });
              console.log('Created new schema mismatch issue');
            }
            
      - name: Send Slack Notification
        if: steps.parse.outputs.issue_count != '0' && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"ðŸš¨ *Schema Mismatch Detected*\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {\"type\": \"plain_text\", \"text\": \"ðŸš¨ Schema Mismatch Detected\"}
                },
                {
                  \"type\": \"section\",
                  \"text\": {\"type\": \"mrkdwn\", \"text\": \"*${{ steps.parse.outputs.issue_count }}* missing column(s) in \`polybot_config\`\"}
                },
                {
                  \"type\": \"section\",
                  \"text\": {\"type\": \"mrkdwn\", \"text\": \"*Missing:*\n\`${{ steps.parse.outputs.missing_columns }}\`\"}
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {\"type\": \"plain_text\", \"text\": \"View Issue\"},
                      \"url\": \"https://github.com/${{ github.repository }}/issues?q=is%3Aopen+label%3Aschema-mismatch\"
                    }
                  ]
                }
              ]
            }" \
            $SLACK_WEBHOOK_URL
            
      - name: Trigger Auto-Fix (Optional)
        if: steps.parse.outputs.issue_count != '0' && env.SUPABASE_MANAGEMENT_TOKEN != ''
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_MANAGEMENT_TOKEN: ${{ secrets.SUPABASE_MANAGEMENT_TOKEN }}
        run: |
          echo "ðŸ”§ Auto-fix is available but requires manual approval"
          echo "To enable auto-fix, set SCHEMA_AUTO_FIX=true in repository secrets"
          # Uncomment below to enable auto-fix:
          # python scripts/auto_fix_schema.py
          
      - name: Summary
        run: |
          if [ "${{ steps.parse.outputs.issue_count }}" -gt 0 ]; then
            echo "::warning::Schema mismatch detected! ${{ steps.parse.outputs.issue_count }} missing columns: ${{ steps.parse.outputs.missing_columns }}"
            echo "## âš ï¸ Schema Validation Warning" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${{ steps.parse.outputs.issue_count }}** missing column(s) detected." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Missing: \`${{ steps.parse.outputs.missing_columns }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A GitHub Issue has been created with the fix SQL." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Schema Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "All frontend fields have corresponding database columns." >> $GITHUB_STEP_SUMMARY
          fi
